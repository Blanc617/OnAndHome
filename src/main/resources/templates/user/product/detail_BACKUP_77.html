<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On&Home</title>
    <link rel="stylesheet" href="/css/import.css" />
    <script src="/js/oncommon.js"></script>
</head>
<body>
<!-- 백그라운드 -->
<div class="on-main-wrap">
    <!-- 헤더 -->
    <header class="on-header">
        <!-- line01 -->
        <div class="on-header-top">
            <div class="on-header-inner">
                <div>
                    <ul class="sns-list">
                        <a href="https://www.facebook.com/?locale=ko_KR" target="_blank"><li class="sns-obj-fb"></li></a>
                        <a href="https://section.blog.naver.com/" target="_blank"><li class="sns-obj-blg"></li></a>
                        <a href="https://www.instagram.com/" target="_blank"><li class="sns-obj-ins"></li></a>
                        <a href="https://www.youtube.com/" target="_blank"><li class="sns-obj-ut"></li></a>
                    </ul>
                </div>
                <div class="login-group">
                    <ul class="login-group-list" id="headerNav">
                        <!-- 동적으로 변경될 네비게이션 -->
                    </ul>
                </div>
            </div>
        </div>
        <!-- line02 -->
        <div class="on-header-top">
            <div class="on-header-inner2">
                <a href="/"><div class="header-logo-placeholder"></div></a>
                <div>
                    <h1>On&Home</h1>
                </div>
                <div class="header-search-area">
                    <input type="text" class="input-m" placeholder="검색어를 입력하세요" />
                    <ul class="header-icons">
                        <li class="ico-mypage"><a href="/user/my_page"></a></li>
                        <li class="ico-cart"><a href="/user/cart"></a></li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- 메뉴 -->
        <div class="on-header-top">
            <div class="on-header-inner">
                <div class="menu-wrapper">
                    <ul class="gnb" id="categoryMenu">
                        <!-- 동적으로 로드될 카테고리 메뉴 -->
                    </ul>
                </div>
            </div>
        </div>
    </header>


    <!-- 아이템영역2  -->
    <div class="on-item02 mb-80">
        <div class="on-item02-inner">
            <h2 class="sub-title cate-tit">상품 상세정보</h2>
            <div class="item-array">
                <div>
                    <div class="item-thum-wrapper detail_thum">
                        <img class="detail_img" id="productThumbnail" src="/product_img/thum_01.jpg" alt="상품 이미지">
                    </div>
                </div>
                <div class="detail-info-wrapper">
                    <h2 id="productName">2025 Crystal UHD UF8500</h2>
                    <div>
                        <table>
                            <th class="detail-info-th">정상가격</th>
                            <td class="detail-price" id="productPrice">2,250,000</td>
                        </table>
                    </div>
                    <div>
                        <table>
                            <th class="detail-info-th">할인가격</th>
                            <td class="detail-sale-price" id="productSalePrice">1,650,000</td>
                        </table>
                    </div>
                    <div>
                        <table>
                            <th class="detail-info-th">제조사</th>
                            <td class="" id="productManufacturer">-</td>
                        </table>
                    </div>
                    <div>
                        <table>
                            <th class="detail-info-th">제조국</th>
                            <td class="" id="productCountry">-</td>
                        </table>
                    </div>
                    <div>
                        <table>
                            <th class="detail-info-th">배송비</th>
                            <td class="">무료</td>
                        </table>
                    </div>
                    <div>
                        <table>
                            <th class="detail-info-th">판매처</th>
                            <td class="">On&Home</td>
                        </table>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-buy" onclick="buyNow()">바로구매</button>
                        <button class="btn btn-cart" onclick="addToCart()">장바구니 담기</button>
                    </div>
                    <div class="border-2p"></div>
                    <div class="detail-total-wrap">
                        <div>
                            <span>주문수량</span>
                            <span class="btn-etc btn-ico--minus" onclick="decreaseQuantity()"></span>
                            <span id="orderQuantity">1</span>
                            <span class="btn-etc btn-ico--plus" onclick="increaseQuantity()"></span>
                        </div>
                        <div class="mr-20">
                            <span>합계금액</span>
                            <span class="total-price" id="totalPrice">0</span>
                            <span>원</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-1p"></div>
            <div class="item-array justify-center mt-40">
                <div class="" id="productDetailImageContainer">
                    <img id="productDetailImage" src="/product_img/detail-001.png" alt="상세 이미지">
                </div>
            </div>
            <div class="border-2p"></div>
            <div>
                <h2 class="mb-12 ml-8">Review</h2>
                <div class="border-1p-nm"></div>
                <div id="reviewList">
                    <!-- 리뷰 목록이 동적으로 로드됩니다 -->
                </div>
                <div class="rep">
                    <textarea id="reviewContent" class="textarea w-full" placeholder="리뷰를 작성해주세요"></textarea>
                    <button class="btn btn--tertiary ml-20" onclick="submitReview()">저장</button>
                </div>
            </div>
            <div class="border-2p mt-40"></div>
            <div>
                <h2 class="mb-12 ml-8">Q&A</h2>
                <div class="border-1p-nm"></div>
                <div class="rep">
                    <div>
                        배송언제와요?
                    </div>
                    <div>
                        <button class="btn btn--tertiary ml-20">답변</button>
                    </div>
                </div>
                <div class="rep">
                    <div class="qna-rep">
                        10월 30일경 배송예정입니다.
                    </div>
                </div>
                <div class="rep">
                    <div>
                        화면 가로크기가 얼마나 되요?
                    </div>
                    <div>
                        <button class="btn btn--tertiary ml-20">답변</button>
                    </div>
                </div>
                <div class="rep">
                    <div>
                        할인 예정없나요?
                    </div>
                    <div>
                        <button class="btn btn--tertiary ml-20">답변</button>
                    </div>
                </div>
                <div class="rep">
                    <div>
                        무게가 어느정도 나가는지 알고 싶어요
                    </div>
                    <div>
                        <button class="btn btn--tertiary ml-20">답변</button>
                    </div>
                </div>
                <div class="rep">
                    <textarea class="textarea w-full"></textarea>
                    <button class="btn btn--tertiary ml-20">작성</button>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="fragments/footer :: footer">
    </div>
</div>

<script>
    // 전역 변수: 현재 상품 정보
    let currentProduct = null;
    // 주문 수량
    let orderQuantity = 1;

    /**
     * 카테고리 데이터
     */
    const categoryData = [
        {
            parentName: 'TV/오디오',
            children: ['TV', '오디오']
        },
        {
            parentName: '주방가전',
            children: ['냉장고', '전자렌지', '식기세척기']
        },
        {
            parentName: '생활가전',
            children: ['세탁기', '청소기']
        },
        {
            parentName: '에어컨/공기청정기',
            children: ['에어컨', '공기청정기']
        },
        {
            parentName: '기타',
            children: ['정수기', '안마의자', 'PC']
        }
    ];

    /**
     * 페이지 로드
     */
    document.addEventListener('DOMContentLoaded', function() {
        loadCategoryMenu();
        loadHeaderNavigation();
        loadProductDetail();
    });

    /**
     * 상품 상세 정보 로드
     */
    function loadProductDetail() {
        // URL에서 상품 ID 추출
        const pathParts = window.location.pathname.split('/');
        const productId = pathParts[pathParts.length - 1];

        if (!productId || isNaN(productId)) {
            alert('잘못된 접근입니다.');
            window.location.href = '/';
            return;
        }

        console.log('상품 ID:', productId);

        // API 호출
        fetch(`/api/products/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('상품을 찾을 수 없습니다.');
                }
                return response.json();
            })
            .then(data => {
                console.log('받은 데이터:', data);
                if (data.success && data.data) {
                    currentProduct = data.data;
                    displayProductDetail(data.data);
                    loadReviews(productId);  // 리뷰 로드
                } else {
                    throw new Error('상품 정보를 불러올 수 없습니다.');
                }
            })
            .catch(error => {
                console.error('상품 로드 오류:', error);
                alert('상품 정보를 불러올 수 없습니다.');
                window.location.href = '/';
            });
    }

    /**
     * 상품 상세 정보 표시
     */
    function displayProductDetail(product) {
        // 상품명
        document.getElementById('productName').textContent = product.name || '상품명 없음';

        // 썸네일 이미지
        const thumbnailImg = document.getElementById('productThumbnail');
        if (product.thumbnailImage) {
            thumbnailImg.src = product.thumbnailImage;
            thumbnailImg.onerror = function() {
                this.src = '/product_img/placeholder.jpg';
            };
        }

        // 정상가격
        const priceFormatted = formatPrice(product.price);
        document.getElementById('productPrice').textContent = priceFormatted;

        // 할인가격
        if (product.salePrice && product.salePrice < product.price) {
            const salePriceFormatted = formatPrice(product.salePrice);
            document.getElementById('productSalePrice').textContent = salePriceFormatted;
        } else {
            // 할인가가 없으면 정상가 표시
            document.getElementById('productSalePrice').textContent = priceFormatted;
        }

        // 제조사 - DB 값 사용
        document.getElementById('productManufacturer').textContent = product.manufacturer || '-';

        // 제조국 - DB 값 사용
        document.getElementById('productCountry').textContent = product.country || '-';

        // 상세 이미지
        const detailImg = document.getElementById('productDetailImage');
        if (product.detailImage) {
            detailImg.src = product.detailImage;
            detailImg.onerror = function() {
                this.src = '/product_img/detail-001.png';
            };
        }

        // 페이지 타이틀 변경
        document.title = product.name + ' - On&Home';

        // 합계금액 초기화
        updateTotalPrice();
    }

    /**
     * 수량 증가
     */
    function increaseQuantity() {
        orderQuantity++;
        updateQuantityDisplay();
        updateTotalPrice();
    }

    /**
     * 수량 감소
     */
    function decreaseQuantity() {
        if (orderQuantity <= 1) {
            alert('최소 주문 수량은 1개입니다.');
            return;
        }
        orderQuantity--;
        updateQuantityDisplay();
        updateTotalPrice();
    }

    /**
     * 수량 표시 업데이트
     */
    function updateQuantityDisplay() {
        document.getElementById('orderQuantity').textContent = orderQuantity;
    }

    /**
     * 합계금액 업데이트
     */
    function updateTotalPrice() {
        if (!currentProduct) {
            return;
        }

        // 할인가격이 있으면 할인가격 사용, 없으면 정상가격 사용
        const pricePerUnit = (currentProduct.salePrice && currentProduct.salePrice < currentProduct.price)
            ? currentProduct.salePrice
            : currentProduct.price;

        const totalPrice = pricePerUnit * orderQuantity;
        document.getElementById('totalPrice').textContent = formatPrice(totalPrice);
    }

    /**
     * 리뷰 목록 로드
     */
    function loadReviews(productId) {
        console.log('리뷰 로드 시작 - productId:', productId);

        fetch(`/api/reviews/product/${productId}`)
            .then(response => {
                console.log('리뷰 API 응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('리뷰 데이터:', data);
                if (data.success && data.data) {
                    displayReviews(data.data);
                } else {
                    console.warn('리뷰 데이터가 없거나 형식이 잘못됨');
                    displayReviews([]);
                }
            })
            .catch(error => {
                console.error('리뷰 로드 오류:', error);
                displayReviews([]);
            });
    }

    /**
     * 리뷰 목록 표시
     */
    function displayReviews(reviews) {
        const reviewList = document.getElementById('reviewList');

        if (reviews.length === 0) {
            reviewList.innerHTML = '<div class="rep"><div>등록된 리뷰가 없습니다.</div></div>';
            return;
        }
<<<<<<< HEAD
=======
        qnaContainer.innerHTML = '';
        qnaList.forEach(q => {
            const replies = (q.replies || []).map(r =>
                `<li>${escapeHtml(r.responder || '관리자')}: ${escapeHtml(r.content || '')}</li>`).join('');
            qnaContainer.insertAdjacentHTML('beforeend', `
        <div class="rep">
          <div><b>${escapeHtml(q.title || '상품 문의')}</b> (${escapeHtml(q.writer || '익명')})</div>
          <div>${escapeHtml(q.question || '')}</div>
          ${replies ? `<ul>${replies}</ul>` : ''}
          <div class="border-1p-nm"></div>
        </div>
      `);
>>>>>>> 1e3bf3ac6456368a167668d59e61764ba7d25d0f

        reviewList.innerHTML = '';
        reviews.forEach(review => {
            // 리뷰 본문
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'rep';
            reviewDiv.innerHTML = `
          <div>${escapeHtml(review.content || '')}</div>
          <div><b>${escapeHtml(review.author || review.username || 'Anonymous')}</b></div>
        `;
            reviewList.appendChild(reviewDiv);

            // 답글 표시 (replies 배열이 있고 비어있지 않은 경우)
            if (review.replies && review.replies.length > 0) {
                review.replies.forEach(reply => {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'rep qna-rep';
                    replyDiv.innerHTML = `
                        <div>${escapeHtml(reply.content || '')}</div>
                        <div><b>${escapeHtml(reply.author || reply.username || 'Admin')}</b></div>
                    `;
                    reviewList.appendChild(replyDiv);
                });
            }
        });
    }

    /**
     * HTML 이스케이프
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * 리뷰 작성
     */
    function submitReview() {
        if (!currentProduct) {
            alert('상품 정보를 불러오는 중입니다.');
            return;
        }

        const content = document.getElementById('reviewContent').value.trim();
        if (!content) {
            alert('리뷰 내용을 입력해주세요.');
            return;
        }

        const reviewData = {
            productId: currentProduct.id,
            content: content,
            rating: 5
        };

        console.log('리뷰 작성 시작:', reviewData);

        fetch('/api/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reviewData)
        })
            .then(response => {
                console.log('리뷰 작성 응답 상태:', response.status);
                return response.json().then(data => ({
                    status: response.status,
                    data: data
                }));
            })
            .then(result => {
                console.log('리뷰 작성 응답:', result);

                if (result.data.success) {
                    alert('리뷰가 등록되었습니다.');
                    document.getElementById('reviewContent').value = '';
                    loadReviews(currentProduct.id);  // 리뷰 목록 새로고침
                } else {
                    alert(result.data.message || '리뷰 등록에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('리뷰 작성 오류:', error);
                alert('리뷰 작성 중 오류가 발생했습니다: ' + error.message);
            });
    }

    /**
     * 가격 포맷팅
     */
    function formatPrice(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /**
     * 바로구매
     */
    function buyNow() {
        if (!currentProduct) {
            alert('상품 정보를 불러오는 중입니다.');
            return;
        }

        // 상품 ID와 수량을 파라미터로 전달하며 주문 페이지로 이동
        window.location.href = `/user/order_payment?productId=${currentProduct.id}&quantity=${orderQuantity}`;
    }

    /**
     * 장바구니 담기
     */
    function addToCart() {
        if (!currentProduct) {
            alert('상품 정보를 불러오는 중입니다.');
            return;
        }

        console.log('장바구니 담기 시작 - 상품ID:', currentProduct.id, '수량:', orderQuantity);

        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productId: currentProduct.id,
                quantity: orderQuantity
            })
        })
            .then(response => {
                console.log('API 응답 상태:', response.status);
                return response.json().then(data => ({
                    status: response.status,
                    body: data
                }));
            })
            .then(result => {
                const { status, body } = result;

                if (body.success) {
                    console.log('장바구니 담기 성공');
                    if (confirm('상품이 장바구니에 추가되었습니다. 장바구니로 이동하시겠습니까?')) {
                        window.location.href = '/user/cart';
                    }
                } else {
                    alert(body.message || '장바구니에 상품을 추가하는 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('장바구니 담기 오류:', error);
                alert('장바구니에 상품을 추가하는 중 오류가 발생했습니다.');
            });
    }

    /**
     * 카테고리 메뉴 로드
     */
    function loadCategoryMenu() {
        const categoryMenu = document.getElementById('categoryMenu');
        categoryMenu.innerHTML = '';

        categoryData.forEach(category => {
            const li = document.createElement('li');

            const parentLink = document.createElement('a');
            parentLink.href = '#';
            parentLink.textContent = category.parentName;
            parentLink.onclick = function(e) {
                e.preventDefault();
                return false;
            };

            li.appendChild(parentLink);

            if (category.children && category.children.length > 0) {
                const depth2 = document.createElement('ul');
                depth2.className = 'depth2';

                category.children.forEach(child => {
                    const childLi = document.createElement('li');
                    const childLink = document.createElement('a');
                    childLink.href = `/user/product/category?category=${encodeURIComponent(child)}`;
                    childLink.textContent = child;
                    childLi.appendChild(childLink);
                    depth2.appendChild(childLi);
                });

                li.appendChild(depth2);
            }

            categoryMenu.appendChild(li);
        });
    }

    /**
     * 헤더 네비게이션 로드
     */
    function loadHeaderNavigation() {
        fetch('/api/user/session-info')
            .then(response => response.json())
            .then(data => {
                const headerNav = document.getElementById('headerNav');
                headerNav.innerHTML = '';

                if (data.loggedIn) {
                    let navHTML = `
              <li><a href="/user/my_page">마이페이지</a></li>
              <li><a href="/user/board/notice/list">공지사항</a></li>
            `;

                    if (data.isAdmin) {
                        navHTML += `<li><a href="/admin/dashboard"><b>관리자</b></a></li>`;
                    }

                    navHTML += `
              <li><a href="#" onclick="handleLogout(); return false;">로그아웃</a></li>
            `;

                    headerNav.innerHTML = navHTML;
                } else {
                    headerNav.innerHTML = `
              <li><a href="/login">로그인</a></li>
              <li><a href="/signup">회원가입</a></li>
              <li><a href="/user/board/notice/list">공지사항</a></li>
            `;
                }
            })
            .catch(error => {
                console.error('세션 정보 조회 실패:', error);
                const headerNav = document.getElementById('headerNav');
                headerNav.innerHTML = `
            <li><a href="/login">로그인</a></li>
            <li><a href="/signup">회원가입</a></li>
            <li><a href="/user/board/notice/list">공지사항</a></li>
          `;
            });
    }

    /**
     * 로그아웃 처리
     */
    function handleLogout() {
        if (confirm('로그아웃 하시겠습니까?')) {
            window.location.href = '/logout';
        }
    }
</script>
</body>
</html>
