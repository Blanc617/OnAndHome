<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>On&Home</title>
  <link rel="stylesheet" href="/css/import.css" />
  <script src="/js/oncommon.js"></script>
</head>
<body>
  <!-- 백그라운드 -->
  <div class="on-main-wrap">
    <!-- 헤더 -->
    <header class="on-header">
      <!-- line01 -->
      <div class="on-header-top">
        <div class="on-header-inner">
          <div>
            <ul class="sns-list">
              <a href="https://www.facebook.com/?locale=ko_KR" target="_blank"><li class="sns-obj-fb"></li></a>
              <a href="https://section.blog.naver.com/" target="_blank"><li class="sns-obj-blg"></li></a>
              <a href="https://www.instagram.com/" target="_blank"><li class="sns-obj-ins"></li></a>
              <a href="https://www.youtube.com/" target="_blank"><li class="sns-obj-ut"></li></a>
            </ul>
          </div>
          <div class="login-group">
            <ul class="login-group-list" id="headerNav">
              <!-- 동적으로 변경될 네비게이션 -->
            </ul>
          </div>
        </div>
      </div>
      <!-- line02 -->
      <div class="on-header-top">
        <div class="on-header-inner2">
          <a href="/"><div class="header-logo-placeholder"></div></a>
          <div>
            <h1>On&Home</h1>
          </div>
          <div class="header-search-area">
            <input type="text" class="input-m" placeholder="검색어를 입력하세요" />
            <ul class="header-icons">
              <li class="ico-mypage"><a href="/user/my_page"></a></li>
              <li class="ico-cart"><a href="/user/cart"></a></li>
            </ul>
          </div>
        </div>
      </div>
      <!-- 메뉴 -->
      <div class="on-header-top">
        <div class="on-header-inner">
          <div class="menu-wrapper">
            <ul class="gnb" id="categoryMenu">
              <!-- 동적으로 로드될 카테고리 메뉴 -->
            </ul>
          </div>
        </div>
      </div>      
    </header>


     <!-- 아이템영역2  -->
    <div class="on-item02 mb-80">
      <div class="on-item02-inner">
        <h2 class="sub-title cate-tit">상품 상세정보</h2>
        <div class="item-array">
          <div>
            <div class="item-thum-wrapper detail_thum">
              <img class="detail_img" id="productThumbnail" src="/product_img/thum_01.jpg" alt="상품 이미지">
            </div>
          </div>
          <div class="detail-info-wrapper">
            <h2 id="productName">2025 Crystal UHD UF8500</h2>
            <div>
              <table>
                <th class="detail-info-th">정상가격</th>
                <td class="detail-price" id="productPrice">2,250,000</td>
              </table>
            </div>
            <div>
              <table>
                <th class="detail-info-th">할인가격</th>
                <td class="detail-sale-price" id="productSalePrice">1,650,000</td>
              </table>
            </div>
            <div>
              <table>
                <th class="detail-info-th">제조사</th>
                <td class="" id="productManufacturer">-</td>
              </table>
            </div>                         
            <div>
              <table>
                <th class="detail-info-th">제조국</th>
                <td class="" id="productCountry">-</td>
              </table>
            </div>
            <div>
              <table>
                <th class="detail-info-th">배송비</th>
                <td class="">무료</td>
              </table>
            </div>
            <div>
              <table>
                <th class="detail-info-th">판매처</th>
                <td class="">On&Home</td>
              </table>
            </div>
            <div class="btn-group">
              <button class="btn btn-buy" onclick="buyNow()">바로구매</button>
              <button class="btn btn-cart" onclick="addToCart()">장바구니 담기</button>
            </div>                                         
          </div>
        </div>
        <div class="border-1p"></div>
        <div class="item-array justify-center mt-40">
          <div class="" id="productDetailImageContainer">
            <img id="productDetailImage" src="/product_img/detail-001.png" alt="상세 이미지">
          </div>
        </div>
        <div class="border-2p"></div>
        <div>
          <h2 class="mb-12 ml-8">Review</h2>
          <div class="border-1p-nm"></div>
          <div class="rep">
            <div>
              배송빠르고 상품이 좋네요
            </div>
            <div>
              <b>faker</b>
            </div>
          </div>
          <div class="rep">
            <div>
              배송빠르고 상품이 좋네요
            </div>
            <div>
              <b>faker</b>
            </div>
          </div>
          <div class="rep">
            <div>
              배송빠르고 상품이 좋네요
            </div>
            <div>
              <b>faker</b>
            </div>
          </div>
          <div class="rep">
            <div>
              배송빠르고 상품이 좋네요
            </div>
            <div>
              <b>faker</b>
            </div>
          </div>
          <div class="rep">
            <textarea class="textarea w-full"></textarea>
            <button class="btn btn--tertiary ml-20">저장</button>
          </div>                              
        </div>
        <div class="border-2p mt-40"></div>
        <div>
          <h2 class="mb-12 ml-8">Q&A</h2>
          <div class="border-1p-nm"></div>
          <div class="rep">
            <div>
              배송언제와요?
            </div>
            <div>
              <button class="btn btn--tertiary ml-20">답변</button>
            </div>            
          </div>
          <div class="rep">
            <div class="qna-rep">
              10월 30일경 배송예정입니다.
            </div>
          </div>
          <div class="rep">
            <div>
              화면 가로크기가 얼마나 되요?
            </div>
            <div>
              <button class="btn btn--tertiary ml-20">답변</button>
            </div>            
          </div>
          <div class="rep">
            <div>
              할인 예정없나요?
            </div>
            <div>
              <button class="btn btn--tertiary ml-20">답변</button>
            </div>            
          </div>
          <div class="rep">
            <div>
              무게가 어느정도 나가는지 알고 싶어요
            </div>
            <div>
              <button class="btn btn--tertiary ml-20">답변</button>
            </div>
          </div>
          <div class="rep">
            <textarea class="textarea w-full"></textarea>
            <button class="btn btn--tertiary ml-20">작성</button>
          </div>                              
        </div>                  
      </div>
    </div>  
    <footer class="footer-o">
      <div class="footer-wrapper">
        <div class="footer-l">
          <div>고객센터 <span class="footer-number">1544-7777</span></div>
          <div class="flex mt-20">
            <div>
              <ul class="footer-title">
                <li>회사명</li>
                <li>대표</li>
                <li>팩스</li>
                <li>이메일</li>
                <li>주소</li>
                <li>사업자등록번호</li>
                <li>통신판매업신고</li>
                <li>개인정보 책임자</li>
              </ul>
            </div>
            <div class="ml-20">
              <ul class="footer-title">
                <li>(주)하이미디어</li>
                <li>이상혁</li>
                <li>02-1544-7778</li>
                <li>faker@naver.com</li>
                <li>서울 서초구 서초동 123-456</li>
                <li>123-456789</li>
                <li>카456-7894</li>
                <li>최우제</li>
              </ul>
            </div>            
          </div>

        </div>
        <div class="footer-r">
          <div>
            <a href="/user/board/review/list"><span class="footer-number">Review 게시판</span></a>
            <div class="footer-review">
              <ul class="footer-title">
                <li>배송 빠르고 좋아요!</li>
                <li>포장 꼼꼼해서 만족합니다</li>
                <li>색감 실물이 더 예뻐요</li>
                <li>가격대비 품질이 훌륭합니다</li>
                <li>설치 기사님 친절했어요</li>
                <li>두 번째 구매인데 역시 좋네요</li>
                <li>응대가 빠르고 친절합니다</li>
              </ul>
            </div>
                      
          </div>
          <div>
            <a href="/user/board/qna/list"><span class="footer-number">Q&A 게시판</span></a>
            <div class="footer-review">
              <ul class="footer-title">
                <li>배송 빠르고 좋아요!</li>
                <li>포장 꼼꼼해서 만족합니다</li>
                <li>색감 실물이 더 예뻐요</li>
                <li>가격대비 품질이 훌륭합니다</li>
                <li>설치 기사님 친절했어요</li>
                <li>두 번째 구매인데 역시 좋네요</li>
                <li>응대가 빠르고 친절합니다</li>
              </ul>
            </div>
            
                      
          </div>

        </div>
      </div>
    </footer>     
  </div>

  <script>
    // 전역 변수: 현재 상품 정보
    let currentProduct = null;

    /**
     * 카테고리 데이터
     */
    const categoryData = [
      {
        parentName: 'TV/오디오',
        children: ['TV', '오디오']
      },
      {
        parentName: '주방가전',
        children: ['냉장고', '전자렌지', '식기세척기']
      },
      {
        parentName: '생활가전',
        children: ['세탁기', '청소기']
      },
      {
        parentName: '에어컨/공기청정기',
        children: ['에어컨', '공기청정기']
      },
      {
        parentName: '기타',
        children: ['정수기', '안마의자', 'PC']
      }
    ];

    /**
     * 페이지 로드
     */
    document.addEventListener('DOMContentLoaded', function() {
      loadCategoryMenu();
      loadHeaderNavigation();
      loadProductDetail();
    });

    /**
     * 상품 상세 정보 로드
     */
    function loadProductDetail() {
      // URL에서 상품 ID 추출
      const pathParts = window.location.pathname.split('/');
      const productId = pathParts[pathParts.length - 1];

      if (!productId || isNaN(productId)) {
        alert('잘못된 접근입니다.');
        window.location.href = '/';
        return;
      }

      console.log('상품 ID:', productId);

      // API 호출
      fetch(`/api/products/${productId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('상품을 찾을 수 없습니다.');
          }
          return response.json();
        })
        .then(data => {
          console.log('받은 데이터:', data);
          if (data.success && data.data) {
            currentProduct = data.data;
            displayProductDetail(data.data);
          } else {
            throw new Error('상품 정보를 불러올 수 없습니다.');
          }
        })
        .catch(error => {
          console.error('상품 로드 오류:', error);
          alert('상품 정보를 불러올 수 없습니다.');
          window.location.href = '/';
        });
    }

    /**
     * 상품 상세 정보 표시
     */
    function displayProductDetail(product) {
      // 상품명
      document.getElementById('productName').textContent = product.name || '상품명 없음';

      // 썸네일 이미지
      const thumbnailImg = document.getElementById('productThumbnail');
      if (product.thumbnailImage) {
        thumbnailImg.src = product.thumbnailImage;
        thumbnailImg.onerror = function() {
          this.src = '/product_img/placeholder.jpg';
        };
      }

      // 정상가격
      const priceFormatted = formatPrice(product.price);
      document.getElementById('productPrice').textContent = priceFormatted;

      // 할인가격
      if (product.salePrice && product.salePrice < product.price) {
        const salePriceFormatted = formatPrice(product.salePrice);
        document.getElementById('productSalePrice').textContent = salePriceFormatted;
      } else {
        // 할인가가 없으면 정상가 표시
        document.getElementById('productSalePrice').textContent = priceFormatted;
      }

      // 제조사 - DB 값 사용
      document.getElementById('productManufacturer').textContent = product.manufacturer || '-';

      // 제조국 - DB 값 사용
      document.getElementById('productCountry').textContent = product.country || '-';

      // 상세 이미지
      const detailImg = document.getElementById('productDetailImage');
      if (product.detailImage) {
        detailImg.src = product.detailImage;
        detailImg.onerror = function() {
          this.src = '/product_img/detail-001.png';
        };
      }

      // 페이지 타이틀 변경
      document.title = product.name + ' - On&Home';
    }

    /**
     * 가격 포맷팅
     */
    function formatPrice(price) {
      return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /**
     * 바로구매
     */
    function buyNow() {
      if (!currentProduct) {
        alert('상품 정보를 불러오는 중입니다.');
        return;
      }
      
      // 상품 ID를 파라미터로 전달하며 주문 페이지로 이동
      window.location.href = `/user/order_payment?productId=${currentProduct.id}&quantity=1`;
    }

    /**
     * 장바구니 담기
     */
    function addToCart() {
      if (!currentProduct) {
        alert('상품 정보를 불러오는 중입니다.');
        return;
      }
      
      const quantity = 1;
      console.log('장바구니 담기 시작 - 상품ID:', currentProduct.id, '수량:', quantity);

      fetch('/api/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          productId: currentProduct.id,
          quantity: quantity
        })
      })
      .then(response => {
        console.log('API 응답 상태:', response.status);
        return response.json().then(data => ({
          status: response.status,
          body: data
        }));
      })
      .then(result => {
        const { status, body } = result;
        
        if (body.success) {
          console.log('장바구니 담기 성공');
          alert('상품이 장바구니에 추가되었습니다.');
          window.location.href = '/user/cart';
        } else {
          alert(body.message || '장바구니에 상품을 추가하는 중 오류가 발생했습니다.');
        }
      })
      .catch(error => {
        console.error('장바구니 담기 오류:', error);
        alert('장바구니에 상품을 추가하는 중 오류가 발생했습니다.');
      });
    }

    /**
     * 카테고리 메뉴 로드
     */
    function loadCategoryMenu() {
      const categoryMenu = document.getElementById('categoryMenu');
      categoryMenu.innerHTML = '';

      categoryData.forEach(category => {
        const li = document.createElement('li');
        
        const parentLink = document.createElement('a');
        parentLink.href = '#';
        parentLink.textContent = category.parentName;
        parentLink.onclick = function(e) {
          e.preventDefault();
          return false;
        };
        
        li.appendChild(parentLink);
        
        if (category.children && category.children.length > 0) {
          const depth2 = document.createElement('ul');
          depth2.className = 'depth2';
          
          category.children.forEach(child => {
            const childLi = document.createElement('li');
            const childLink = document.createElement('a');
            childLink.href = `/user/product/category?category=${encodeURIComponent(child)}`;
            childLink.textContent = child;
            childLi.appendChild(childLink);
            depth2.appendChild(childLi);
          });
          
          li.appendChild(depth2);
        }
        
        categoryMenu.appendChild(li);
      });
    }

    /**
     * 헤더 네비게이션 로드
     */
    function loadHeaderNavigation() {
      fetch('/api/user/session-info')
        .then(response => response.json())
        .then(data => {
          const headerNav = document.getElementById('headerNav');
          headerNav.innerHTML = '';

          if (data.loggedIn) {
            let navHTML = `
              <li><a href="/user/my_page">마이페이지</a></li>
              <li><a href="/user/board/notice/list">공지사항</a></li>
            `;

            if (data.isAdmin) {
              navHTML += `<li><a href="/admin/dashboard"><b>관리자</b></a></li>`;
            }

            navHTML += `
              <li><a href="#" onclick="handleLogout(); return false;">로그아웃</a></li>
            `;

            headerNav.innerHTML = navHTML;
          } else {
            headerNav.innerHTML = `
              <li><a href="/login">로그인</a></li>
              <li><a href="/signup">회원가입</a></li>
              <li><a href="/">공지사항</a></li>
            `;
          }
        })
        .catch(error => {
          console.error('세션 정보 조회 실패:', error);
          const headerNav = document.getElementById('headerNav');
          headerNav.innerHTML = `
            <li><a href="/login">로그인</a></li>
            <li><a href="/signup">회원가입</a></li>
            <li><a href="/">공지사항</a></li>
          `;
        });
    }

    /**
     * 로그아웃 처리
     */
    function handleLogout() {
      if (confirm('로그아웃 하시겠습니까?')) {
        window.location.href = '/logout';
      }
    }
  </script>
</body>
</html>
