<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On&Home</title>
    <link rel="stylesheet" href="/css/import.css" />
    <script src="/js/oncommon.js"></script>
</head>
<body>
<!-- 백그라운드 -->
<div class="on-main-wrap">
    <!-- 헤더 -->
    <div th:replace="~{fragments/header :: header}"></div>


    <!-- 아이템영역2  -->
    <div class="on-item02 mb-80 mt-80">
        <div class="on-item02-inner">
            <h2 class="sub-title line-under">나의 주문내역</h2>
            <h3 class="mb-20">배송정보</h3>
            <table class="table mb-40">
                <colgroup>
                    <col width="20%">
                    <col width="30%">
                    <col width="20%">
                    <col width="30%">
                </colgroup>
                <tbody id="deliveryInfoTable">
                <!-- 동적으로 로드될 배송정보 -->
                </tbody>
            </table>
            <h3 class="mb-20">주문정보</h3>
            <table class="table">
                <colgroup>
                    <col width="20%">
                    <col width="35%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                    <col width="">
                </colgroup>
                <tbody id="orderInfoTable">
                <!-- 동적으로 로드될 주문정보 -->
                </tbody>
            </table>
        </div>
    </div>
    <footer class="footer-o">
        <div class="footer-wrapper">
            <div class="footer-l">
                <div>고객센터 <span class="footer-number">1544-7777</span></div>
                <div class="flex mt-20">
                    <div>
                        <ul class="footer-title">
                            <li>회사명</li>
                            <li>대표</li>
                            <li>팩스</li>
                            <li>이메일</li>
                            <li>주소</li>
                            <li>사업자등록번호</li>
                            <li>통신판매업신고</li>
                            <li>개인정보 책임자</li>
                        </ul>
                    </div>
                    <div class="ml-20">
                        <ul class="footer-title">
                            <li>(주)하이미디어</li>
                            <li>이상혁</li>
                            <li>02-1544-7778</li>
                            <li>faker@naver.com</li>
                            <li>서울 서초구 서초동 123-456</li>
                            <li>123-456789</li>
                            <li>카456-7894</li>
                            <li>최우제</li>
                        </ul>
                    </div>
                </div>

            </div>
            <div class="footer-r">
                <div>
                    <a href="/user/board/review/list"><span class="footer-number">Review 게시판</span></a>
                    <div class="footer-review">
                        <ul class="footer-title">
                            <li>배송 빠르고 좋아요!</li>
                            <li>포장 꼼꼼해서 만족합니다</li>
                            <li>색감 실물이 더 예빠요</li>
                            <li>가격대비 품질이 훌륭합니다</li>
                            <li>설치 기사님 친절했어요</li>
                            <li>두 번째 구매인데 역시 좋네요</li>
                            <li>응대가 빠르고 친절합니다</li>
                        </ul>
                    </div>

                </div>
                <div>
                    <a href="/user/board/qna/list"><span class="footer-number">Q&A 게시판</span></a>
                    <div class="footer-review">
                        <ul class="footer-title">
                            <li>배송 빠르고 좋아요!</li>
                            <li>포장 꼼꼼해서 만족합니다</li>
                            <li>색감 실물이 더 예빠요</li>
                            <li>가격대비 품질이 훌륭합니다</li>
                            <li>설치 기사님 친절했어요</li>
                            <li>두 번째 구매인데 역시 좋네요</li>
                            <li>응대가 빠르고 친절합니다</li>
                        </ul>
                    </div>


                </div>

            </div>
        </div>
    </footer>
</div>

<script>
    /**
     * 카테고리 데이터
     */
    const categoryData = [
        {
            parentName: 'TV/오디오',
            children: ['TV', '오디오']
        },
        {
            parentName: '주방가전',
            children: ['냉장고', '전자렌지', '식기세척기']
        },
        {
            parentName: '생활가전',
            children: ['세탁기', '청소기']
        },
        {
            parentName: '에어컨/공기청정기',
            children: ['에어컨', '공기청정기']
        },
        {
            parentName: '기타',
            children: ['정수기', '안마의자', 'PC']
        }
    ];

    /**
     * 페이지 로드
     */
    document.addEventListener('DOMContentLoaded', function() {
        loadCategoryMenu();
        loadHeaderNavigation();
        loadLatestOrder();
    });

    /**
     * 최근 주문 내역 로드
     */
    function loadLatestOrder() {
        fetch('/api/user/session-info')
            .then(response => response.json())
            .then(data => {
                if (data.loggedIn && data.user) {
                    const userId = data.user.id;
                    // 사용자의 주문 목록 가져오기
                    return fetch(`/api/orders/user/${userId}`);
                } else {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                    throw new Error('Not logged in');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    // 가장 최근 주문 (배열의 첫 번째 항목)
                    const latestOrder = data.data[0];
                    displayOrderInfo(latestOrder);
                } else {
                    displayNoOrders();
                }
            })
            .catch(error => {
                console.error('주문 내역 로드 오류:', error);
                if (error.message !== 'Not logged in') {
                    displayNoOrders();
                }
            });
    }

    /**
     * 주문 정보 표시
     */
    function displayOrderInfo(order) {
        // 배송정보 표시
        const deliveryInfoTable = document.getElementById('deliveryInfoTable');

        // sessionStorage에서 배송정보 가져오기 (주문 시 저장한 정보)
        const deliveryInfo = sessionStorage.getItem('deliveryInfo');
        let deliveryData = null;

        if (deliveryInfo) {
            try {
                deliveryData = JSON.parse(deliveryInfo);
            } catch (e) {
                console.error('배송정보 파싱 오류:', e);
            }
        }

        // 배송정보 HTML 생성
        deliveryInfoTable.innerHTML = `
        <tr>
          <th>이름</th>
          <td>${deliveryData ? deliveryData.name : order.username || '-'}</td>
          <th>ID</th>
          <td>${deliveryData ? deliveryData.userId : order.userIdStr || '-'}</td>
        </tr>
        <tr>
          <th>전화번호</th>
          <td>${deliveryData ? deliveryData.phone : order.userPhone || '-'}</td>
          <th>e-mail</th>
          <td>${deliveryData ? deliveryData.email : order.userEmail || '-'}</td>
        </tr>
        <tr>
          <th>주소</th>
          <td colspan="3">${deliveryData ? deliveryData.address : order.userAddress || '-'}</td>
        </tr>
        <tr>
          <th>요청사항</th>
          <td colspan="3">${deliveryData && deliveryData.request ? deliveryData.request : '-'}</td>
        </tr>
      `;

        // 주문정보 표시
        const orderInfoTable = document.getElementById('orderInfoTable');

        // 주문번호 (서버에서 생성된 값 사용)
        const orderNumber = order.orderNumber || 'N/A';

        let itemsHtml = '';

        // 각 주문 아이템 표시
        order.orderItems.forEach(item => {
            const price = item.orderPrice || 0;
            const quantity = item.quantity || 0;
            const itemTotal = price * quantity;

            itemsHtml += `
          <tr>
            <th>상품명</th>
            <td>${item.productName}</td>
            <th>수량</th>
            <td class="center">${quantity}</td>
            <th>가격</th>
            <td class="right">${formatPrice(itemTotal)}</td>
          </tr>
        `;
        });

        // 서버에서 계산된 총 가격 사용
        const totalPrice = order.totalPrice || 0;

        // 테이블 내용 설정
        orderInfoTable.innerHTML = `
        <tr>
          <th>주문번호</th>
          <td colspan="5">${orderNumber}</td>
        </tr>
        <tr>
          <th>주문상품 리스트</th>
          <th colspan="5"></th>
        </tr>
        ${itemsHtml}
        <tr class="high-50">
          <th>주문 합계</th>
          <td colspan="5" class="right"><span class="price-b">${formatPrice(totalPrice)}</span><span class="ml-12">원</span></td>
        </tr>
      `;
    }

    /**
     * 주문 내역이 없을 때 표시
     */
    function displayNoOrders() {
        const deliveryInfoTable = document.getElementById('deliveryInfoTable');
        deliveryInfoTable.innerHTML = `
        <tr>
          <td colspan="4" style="text-align: center; padding: 40px;">
            <h3>주문 내역이 없습니다.</h3>
            <p style="margin-top: 10px;">
              <a href="/" style="color: #007bff; text-decoration: underline;">쇼핑하러 가기</a>
            </p>
          </td>
        </tr>
      `;

        const orderInfoTable = document.getElementById('orderInfoTable');
        orderInfoTable.innerHTML = '';
    }

    /**
     * 주문번호 생성
     */
    function generateOrderNumber(orderId, orderDate) {
        if (orderDate) {
            // orderDate를 파싱하여 YYYYMMDD 형식으로 변환
            const date = new Date(orderDate);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}-${String(orderId).padStart(6, '0')}`;
        }
        return `ORDER-${orderId}`;
    }

    /**
     * 가격 포매팅
     */
    function formatPrice(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /**
     * 카테고리 메뉴 로드
     */
    function loadCategoryMenu() {
        const categoryMenu = document.getElementById('categoryMenu');
        categoryMenu.innerHTML = '';

        categoryData.forEach(category => {
            const li = document.createElement('li');

            const parentLink = document.createElement('a');
            parentLink.href = '#';
            parentLink.textContent = category.parentName;
            parentLink.onclick = function(e) {
                e.preventDefault();
                return false;
            };

            li.appendChild(parentLink);

            if (category.children && category.children.length > 0) {
                const depth2 = document.createElement('ul');
                depth2.className = 'depth2';

                category.children.forEach(child => {
                    const childLi = document.createElement('li');
                    const childLink = document.createElement('a');
                    childLink.href = `/user/product/category?category=${encodeURIComponent(child)}`;
                    childLink.textContent = child;
                    childLi.appendChild(childLink);
                    depth2.appendChild(childLi);
                });

                li.appendChild(depth2);
            }

            categoryMenu.appendChild(li);
        });
    }

    /**
     * 헤더 네비게이션 로드
     */
    function loadHeaderNavigation() {
        fetch('/api/user/session-info')
            .then(response => response.json())
            .then(data => {
                const headerNav = document.getElementById('headerNav');
                headerNav.innerHTML = '';

                if (data.loggedIn) {
                    let navHTML = `
              <li><a href="/user/my_page">마이페이지</a></li>
              <li><a href="/user/board/notice/list">공지사항</a></li>
            `;

                    if (data.isAdmin) {
                        navHTML += `<li><a href="/admin/dashboard"><b>관리자</b></a></li>`;
                    }

                    navHTML += `
              <li><a href="#" onclick="handleLogout(); return false;">로그아웃</a></li>
            `;

                    headerNav.innerHTML = navHTML;
                } else {
                    headerNav.innerHTML = `
              <li><a href="/login">로그인</a></li>
              <li><a href="/signup">회원가입</a></li>
              <li><a href="/">공지사항</a></li>
            `;
                }
            })
            .catch(error => {
                console.error('세션 정보 조회 실패:', error);
                const headerNav = document.getElementById('headerNav');
                headerNav.innerHTML = `
            <li><a href="/login">로그인</a></li>
            <li><a href="/signup">회원가입</a></li>
            <li><a href="/">공지사항</a></li>
          `;
            });
    }

    /**
     * 로그아웃 처리
     */
    function handleLogout() {
        if (confirm('로그아웃 하시겠습니까?')) {
            window.location.href = '/logout';
        }
    }
</script>
</body>
</html>
