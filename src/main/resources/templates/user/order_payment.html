<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>On&Home</title>
  <link rel="stylesheet" href="/css/import.css" />
  <script src="/js/oncommon.js"></script>
  
</head>
<body>
  <!-- 백그라운드 -->
  <div class="on-main-wrap">
    <!-- 헤더 -->
    <header class="on-header">
      <!-- line01 -->
      <div class="on-header-top">
        <div class="on-header-inner">
          <div>
            <ul class="sns-list">
              <a href="https://www.facebook.com/?locale=ko_KR" target="_blank"><li class="sns-obj-fb"></li></a>
              <a href="https://section.blog.naver.com/" target="_blank"><li class="sns-obj-blg"></li></a>
              <a href="https://www.instagram.com/" target="_blank"><li class="sns-obj-ins"></li></a>
              <a href="https://www.youtube.com/" target="_blank"><li class="sns-obj-ut"></li></a>
            </ul>
          </div>
          <div class="login-group">
            <ul class="login-group-list">
              <li><a href="/user/login.html">로그인</a></li>
              <li><a href="/user/regeist.html">회원가입</a></li>
              <li><a href="/user/notice.html">공지사항</a></li>
            </ul>
          </div>
        </div>
      </div>
      <!-- line02 -->
      <div class="on-header-top">
        <div class="on-header-inner2">
          <a href=""><div class="header-logo-placeholder"></div></a>
          <div>
            <h1>On&Home</h1>
          </div>
          <div class="header-search-area">
            <input type="text" class="input-m" placeholder="검색어를 입력하세요" />
            <ul class="header-icons">
              <li class="ico-mypage"><a href="#"></a></li>
              <li class="ico-cart"><a href="#"></a></li>
            </ul>
          </div>
        </div>
      </div>
      <!-- 메뉴 -->
      <div class="on-header-top">
        <div class="on-header-inner">
          <div class="menu-wrapper">
            <ul class="gnb">
              <li>
                <a href="#">TV/오디오</a>
                <ul class="depth2">
                  <li><a href="#">TV</a></li>
                  <li><a href="#">오디오</a></li>
                </ul>
              </li>
              <li>
                <a href="#">주방가전</a>
                <ul class="depth2">
                  <li><a href="#">냉장고</a></li>
                  <li><a href="#">전자렌지</a></li>
                  <li><a href="#">식기세척기</a></li>
                </ul>
              </li>
              <li>
                <a href="#">생활가전</a>
                <ul class="depth2">
                  <li><a href="#">세탁기</a></li>
                  <li><a href="#">청소기</a></li>
                </ul>
              </li>
              <li>
                <a href="#">에어컨/공기청정기</a>
                <ul class="depth2">
                  <li><a href="#">에어컨</a></li>
                  <li><a href="#">공기청정기</a></li>
                </ul>
              </li>
              <li>
                <a href="#">기타</a>
                <ul class="depth2">
                  <li><a href="#">정수기</a></li>
                  <li><a href="#">안마의자</a></li>
                  <li><a href="#">PC</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>      
    </header>


     <!-- 아이템영역2  -->
    <div class="on-item02 mb-80 mt-80">
      <div class="on-item02-inner">
        <h2 class="sub-title line-under">주문/결제</h2>
        <h3 class="mb-20">배송정보</h3>
        <table class="table mb-40">
          <colgroup>
            <col width="20%">
            <col width="30%">
            <col width="20%">
            <col width="30%">
          </colgroup>
          <tbody>
            <tr>
              <th>이름</th>
              <td>
                <input class="input w-full">
              </td>
              <th>ID</th>
              <td>
                <input class="input w-full">                
              </td>
            </tr>
            <tr>
              <th>전화번호</th>
              <td>
                <input class="input w-full">                
              </td>
              <th>e-mail</th>
              <td>
                <input class="input w-full">                
              </td>
            </tr>
            <tr>
              <th>주소</th>
              <td colspan="3">
                <input class="input w-full">                
              </td>
            </tr>
            <tr>
              <th>요청사항</th>
              <td colspan="3">
                <textarea class="textarea w-full"></textarea>
              </td>
            </tr>            
          </tbody>
        </table>
        <h3 class="mb-20">주문정보</h3>
        <table class="table">
          <colgroup>
            <col width="20%">
            <col width="35%">
            <col width="10%">
            <col width="10%">
            <col width="10%">
            <col width="">
          </colgroup>
          <tbody>
            <tr>
              <th>주문번호</th>
              <td colspan="5">123456-456789</td>
            </tr>
            <tr>
              <th>주문상품 리스트</th>
              <th colspan="5"></th>
            </tr>
            <tr>
              <th>상품명</th>
              <td>Dyson Pure Cool 공기청정기</td>
              <th>수량</th>
              <td class="center">1</td>
              <th>가격</th>
              <td class="right">790,000</td>                                
            </tr>
            <tr>
              <th>상품명</th>
              <td>Apple iPhone 16 Pro</td>
              <th>수량</th>
              <td class="center">1</td>
              <th>가격</th>
              <td class="right">1,450,000</td>                                
            </tr>            
            <tr class="high-50">
              <th>주문 합계</th>
              <td colspan="5" class="right"><span class="price-b">2,240,000</span><span class="ml-12">원</span></td>
            </tr>         
          </tbody>
        </table>
      </div>
      <div class="btn-group justify-center mt-40">
          <button class="btn btn-buy" id="btnPay">결제하기</button>
      </div>       
    </div>  
    <footer class="footer-o">
      <div class="footer-wrapper">
        <div class="footer-l">
          <div>고객센터 <span class="footer-number">1544-7777</span></div>
          <div class="flex mt-20">
            <div>
              <ul class="footer-title">
                <li>회사명</li>
                <li>대표</li>
                <li>팩스</li>
                <li>이메일</li>
                <li>주소</li>
                <li>사업자등록번호</li>
                <li>통신판매업신고</li>
                <li>개인정보 책임자</li>
              </ul>
            </div>
            <div class="ml-20">
              <ul class="footer-title">
                <li>(주)하이미디어</li>
                <li>이상혁</li>
                <li>02-1544-7778</li>
                <li>faker@naver.com</li>
                <li>서울 서초구 서초동 123-456</li>
                <li>123-456789</li>
                <li>카456-7894</li>
                <li>최우제</li>
              </ul>
            </div>            
          </div>

        </div>
        <div class="footer-r">
          <div>
            <span class="footer-number">Review 게시판</span>
            <div class="footer-review">
              <ul class="footer-title">
                <li>배송 빠르고 좋아요!</li>
                <li>포장 꼼꼼해서 만족합니다</li>
                <li>색감 실물이 더 예뻐요</li>
                <li>가격대비 품질이 훌륭합니다</li>
                <li>설치 기사님 친절했어요</li>
                <li>두 번째 구매인데 역시 좋네요</li>
                <li>응대가 빠르고 친절합니다</li>
              </ul>
            </div>
                      
          </div>
          <div>
            <span class="footer-number">Q&A 게시판</span>
            <div class="footer-review">
              <ul class="footer-title">
                <li>배송 빠르고 좋아요!</li>
                <li>포장 꼼꼼해서 만족합니다</li>
                <li>색감 실물이 더 예뻐요</li>
                <li>가격대비 품질이 훌륭합니다</li>
                <li>설치 기사님 친절했어요</li>
                <li>두 번째 구매인데 역시 좋네요</li>
                <li>응대가 빠르고 친절합니다</li>
              </ul>
            </div>
            
                      
          </div>

        </div>
      </div>
    </footer>     
  </div>

  <script>
    // 전역 변수: 주문 상품 정보
    let orderProduct = null;
    let orderQuantity = 1;

    /**
     * 페이지 로드
     */
    document.addEventListener('DOMContentLoaded', function() {
      loadOrderInfo();
    });

    /**
     * URL 파라미터에쓜 상품 ID 추출
     */
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    /**
     * 주문 정보 로드
     */
    function loadOrderInfo() {
      const productId = getUrlParameter('productId');
      const quantity = getUrlParameter('quantity') || 1;

      if (!productId) {
        alert('잘못된 접근입니다.');
        window.location.href = '/';
        return;
      }

      orderQuantity = parseInt(quantity);

      // 상품 정보 로드
      fetch(`/api/products/${productId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('상품을 찾을 수 없습니다.');
          }
          return response.json();
        })
        .then(data => {
          if (data.success && data.data) {
            orderProduct = data.data;
            displayOrderInfo();
            loadUserInfo();
          } else {
            throw new Error('상품 정보를 불러올 수 없습니다.');
          }
        })
        .catch(error => {
          console.error('상품 로드 오류:', error);
          alert('상품 정보를 불러올 수 없습니다.');
          window.location.href = '/';
        });
    }

    /**
     * 주문 정보 표시
     */
    function displayOrderInfo() {
      if (!orderProduct) return;

      // 주문번호 생성 (현재 시간 기반)
      const orderNumber = generateOrderNumber();
      
      // 주문정보 테이블 수정
      const tableBody = document.querySelector('table.table:nth-of-type(2) tbody');
      
      // 가격 계산 (할인가가 있으면 할인가, 없으면 정상가)
      const price = orderProduct.salePrice && orderProduct.salePrice > 0 
        ? orderProduct.salePrice 
        : orderProduct.price;
      const totalPrice = price * orderQuantity;

      // 테이블 내용 교체
      tableBody.innerHTML = `
        <tr>
          <th>주문번호</th>
          <td colspan="5">${orderNumber}</td>
        </tr>
        <tr>
          <th>주문상품 리스트</th>
          <th colspan="5"></th>
        </tr>
        <tr>
          <th>상품명</th>
          <td>${orderProduct.name}</td>
          <th>수량</th>
          <td class="center">${orderQuantity}</td>
          <th>가격</th>
          <td class="right">${formatPrice(price)}</td>
        </tr>
        <tr class="high-50">
          <th>주문 합계</th>
          <td colspan="5" class="right"><span class="price-b">${formatPrice(totalPrice)}</span><span class="ml-12">원</span></td>
        </tr>
      `;
    }

    /**
     * 주문번호 생성
     */
    function generateOrderNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
      return `${year}${month}${day}-${random}`;
    }

    /**
     * 가격 포매팅
     */
    function formatPrice(price) {
      return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /**
     * 사용자 정보 로드
     */
    function loadUserInfo() {
      fetch('/api/user/session-info')
        .then(response => response.json())
        .then(data => {
          if (data.loggedIn && data.user) {
            // 사용자 정보가 있으면 폼에 채우기
            const inputs = document.querySelectorAll('table.table:first-of-type input, table.table:first-of-type textarea');
            if (inputs.length >= 5) {
              inputs[0].value = data.user.username || ''; // 이름
              inputs[1].value = data.user.userId || ''; // ID
              inputs[2].value = data.user.phone || ''; // 전화번호
              inputs[3].value = data.user.email || ''; // 이메일
              inputs[4].value = data.user.address || ''; // 주소
            }
          }
        })
        .catch(error => {
          console.error('사용자 정보 로드 실패:', error);
          // 사용자 정보 로드 실패해도 주문은 계속 진행 가능
        });
    }

    /**
     * 결제하기 버튼 이벤트
     */
    document.getElementById('btnPay').addEventListener('click', function() {
      // 배송정보 검증
      const inputs = document.querySelectorAll('table.table:first-of-type input, table.table:first-of-type textarea');
      const name = inputs[0].value.trim();
      const phone = inputs[2].value.trim();
      const address = inputs[4].value.trim();

      if (!name) {
        alert('이름을 입력해주세요.');
        inputs[0].focus();
        return;
      }

      if (!phone) {
        alert('전화번호를 입력해주세요.');
        inputs[2].focus();
        return;
      }

      if (!address) {
        alert('주소를 입력해주세요.');
        inputs[4].focus();
        return;
      }

      // TODO: 실제 결제 API 연동
      if (confirm('결제를 진행하시겠습니까?')) {
        alert('결제 기능은 현재 개발 중입니다.');
        // 결제 성공 후 주문 완료 페이지로 이동
        // window.location.href = '/user/order_complete';
      }
    });
  </script>
</body>
</html>
